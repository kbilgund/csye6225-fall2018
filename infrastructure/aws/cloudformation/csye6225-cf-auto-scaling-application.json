{
  "AWSTemplateFormatVersion" : "2010-09-09",
  "Description" : "Application Stack",
  "Parameters" : {
    "VpcId": {
        "Type": "String"
    },
    "ELBId1": {
        "Type": "String"
    },
    "ELBId2": {
        "Type": "String"
    },
    "ELBId3": {
        "Type": "String"
    },
    "GroupSubnetId2": {
      "Type": "String"
    },
    "GroupSubnetId1": {
      "Type": "String"
    },
    "DomainName" :{
      "Type": "String"
    }  
  },
  "Resources": {
    "LoadBalancerSecurityGroup" : {
            "Type" : "AWS::EC2::SecurityGroup",
            "Properties" : {
              "Tags": [
                  {
                      "Key": "Name",
                      "Value": "csye6225-load"
                  }
              ],
                  "GroupDescription" : "Enable HTTP access on the 80 and 443 port",
                  "VpcId" : { "Ref" : "VpcId" },
                  "SecurityGroupIngress" : [
                      {
                        "IpProtocol" : "tcp",
                          "FromPort" : "80",
                          "ToPort" : "80",
                          "CidrIp" : "0.0.0.0/0"},
                      {
                        "IpProtocol" : "tcp",
                          "FromPort" : "443",
                          "ToPort" : "443",
                          "CidrIp" : "0.0.0.0/0"},
                      ]
                    }
                  },
                  "AutoScalingSecurityGroup" : {
                          "Type" : "AWS::EC2::SecurityGroup",
                          "Properties" : {
                            "Tags": [
                                {
                                    "Key": "Name",
                                    "Value": "csye6225-autoscaling"
                                }
                            ],
                                "GroupDescription" : "Enable HTTP access on the configured port",
                                "VpcId" : { "Ref" : "VpcId" },
                                "SecurityGroupIngress" : [ {
                                  "IpProtocol" : "tcp",
                                      "FromPort" : "22",
                                      "ToPort" : "22",
                                      "CidrIp" : "0.0.0.0/0"},
                                    {
                                      "IpProtocol" : "tcp",
                                        "FromPort" : "80",
                                        "ToPort" : "80",
                                        "SourceSecurityGroupId" : { "Ref" : "LoadBalancerSecurityGroup" }
                                      },
                                    ]
                                  }
                                },
                                "loadBalancer" : {
                                  "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
                                  "Properties": {
                                    "Scheme" : "internet-facing",
                                    "Name" : "csye6225-load",
                                    "Subnets" : [ {"Ref": "ELBId1"} , {"Ref": "ELBId2"} , {"Ref": "ELBId3"}  ],
                                    "LoadBalancerAttributes" : [
                                      { "Key" : "idle_timeout.timeout_seconds", "Value" : "50" }
                                    ],
                                    "SecurityGroups": [{"Ref":"LoadBalancerSecurityGroup"}],
                                    "Tags" : [
                                    { "Key" : "key", "Value" : "value" }
                                ]
                              }
                            },

                            "LoadBalancerListener":{
                                "Type": "AWS::ElasticLoadBalancingV2::Listener",
                                "Properties":{
                                  "LoadBalancerArn": {"Ref": "loadBalancer"},
                                  "Port": 443,
                                  "Protocol": "HTTPS",
                                  "Certificates": [
                                            {
                                                "CertificateArn": {"Ref": "CertificateArn"}
                                            }
                                        ],
                                  "DefaultActions": [{
                                    "Type": "forward",
                                    "TargetGroupArn": { "Ref": "TargetGroup" }
                                    }],
                                }
                            },
                            "TargetGroup": {
                                    "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
                                    "Properties": {
                                        "HealthCheckPath" : "/health",
                                        "HealthCheckPort" : "80",
                                        "Port": 80,
                                        "Protocol": "HTTP",
                                        "TargetType": "instance",
                                        "VpcId": {
                                            "Ref": "VpcId"
                                        }
                                    }
                                },
                          "LaunchConfig":{
                             "Type" : "AWS::AutoScaling::LaunchConfiguration",
                             "Properties" : {
                                "AssociatePublicIpAddress" : true,
                                "KeyName" : "ec2_centos",
                                "ImageId": "ami-9887c6e7",
                                "InstanceType": "t2.micro",
                                "IamInstanceProfile":"CodeDeployEC2ServiceRole",
                                "LaunchConfigurationName" : "asg_launch_config",
                                "SecurityGroups" : [{"Ref": "AutoScalingSecurityGroup"}],
                                "UserData": {
                                    "Fn::Base64": {
                                        "Fn::Join": [
                                            "\n",
                                            [

                                              "#!/bin/bash -xe ",

                                              "yum install ruby ntp wget java-1.8.0-openjdk-devel mysql bind-utils git -y",

                                              "systemctl start ntpd",

                                              "systemctl enable ntpd",

                                              "mkdir temp",

                                              "cd temp",

                                              "pwd >> log",

                                              "wget https://aws-codedeploy-us-east-1.s3.amazonaws.com/latest/install >> log",

                                              "chmod +x ./install >> log",

                                              "./install auto >> log",

                                              "touch log1",

                                              "cd /",

                                              "/bin/echo 'export s3=\"",{"Ref": "DomainName"},"\"' | tr -d '\n' >> app",

                                              "/bin/echo '' >> app",

                                              "/bin/echo 'export db=\"",{"Fn::GetAtt": ["DBInstance","Endpoint.Address"]},"\"' | tr -d '\n' >> app",

                                              "wget https://s3.amazonaws.com/amazoncloudwatch-agent/centos/amd64/latest/amazon-cloudwatch-agent.rpm",

                                              "sudo rpm -U ./amazon-cloudwatch-agent.rpm",

                                              "sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -c ssm:AmazonCloudWatch-linux -s"
                                            ]
                                        ]
                                    }
                              }
                             }
                           },
                           "WebServerGroup" : {
                             "Type" : "AWS::AutoScaling::AutoScalingGroup",
                             "DependsOn":"LoadBalancerListener",
                             "Properties" : {
                               "Cooldown" : "60",
                               "VPCZoneIdentifier" : [{"Ref": "ELBId1"} , {"Ref": "ELBId2"} , {"Ref": "ELBId3"} ],
                               "DesiredCapacity" : "3",
                               "LaunchConfigurationName" : { "Ref" : "LaunchConfig" },
                               "MinSize" : "3",
                               "MaxSize" : "10",
                               "TargetGroupARNs":[{"Ref":"TargetGroup"}],
                               "Tags": [
                                   {
                                       "Key": "Name",
                                       "Value": "centOS",
                                       "PropagateAtLaunch" : "true"
                                   }
                               ],
                                }
                              },
                              "WebServerScaleUpPolicy": {
                            "Type": "AWS::AutoScaling::ScalingPolicy",
                            "Properties": {
                              "AdjustmentType": "ChangeInCapacity",
                              "AutoScalingGroupName": {
                                "Ref": "WebServerGroup"
                              },
                              "Cooldown": "60",
                              "ScalingAdjustment": "1"
                            }
                          },
                          "WebServerScaleDownPolicy": {
                            "Type": "AWS::AutoScaling::ScalingPolicy",
                            "Properties": {
                              "AdjustmentType": "ChangeInCapacity",
                              "AutoScalingGroupName": {
                                "Ref": "WebServerGroup"
                              },
                              "Cooldown": "60",
                              "ScalingAdjustment": "-1"
                            }
                          },
                          "CPUAlarmHigh": {
                            "Type": "AWS::CloudWatch::Alarm",
                            "Properties": {
                              "AlarmDescription": "Scale-up if CPU > 90% for 10 minutes",
                              "MetricName": "CPUUtilization",
                              "Namespace": "AWS/EC2",
                              "Statistic": "Average",
                              "Period": "300",
                              "EvaluationPeriods": "2",
                              "Threshold": "90",
                              "AlarmActions": [
                                {
                                  "Ref": "WebServerScaleUpPolicy"
                                }
                              ],
                              "Dimensions": [
                                {
                                  "Name": "AutoScalingGroupName",
                                  "Value": {
                                    "Ref": "WebServerGroup"
                                  }
                                }
                              ],
                              "ComparisonOperator": "GreaterThanThreshold"
                            }
                          },
                          "CPUAlarmLow": {
                            "Type": "AWS::CloudWatch::Alarm",
                            "Properties": {
                              "AlarmDescription": "Scale-down if CPU < 70% for 10 minutes",
                              "MetricName": "CPUUtilization",
                              "Namespace": "AWS/EC2",
                              "Statistic": "Average",
                              "Period": "300",
                              "EvaluationPeriods": "2",
                              "Threshold": "70",
                              "AlarmActions": [
                                {
                                  "Ref": "WebServerScaleDownPolicy"
                                }
                              ],
                              "Dimensions": [
                                {
                                  "Name": "AutoScalingGroupName",
                                  "Value": {
                                    "Ref": "WebServerGroup"
                                  }
                                }
                              ],
                              "ComparisonOperator": "LessThanThreshold"
                            }
                          },
                    "DBSecurityGroup" : {
                            "Type" : "AWS::EC2::SecurityGroup",
                            "Properties" : {
                              "Tags": [
                                  {
                                      "Key": "Name",
                                      "Value": "csye6225-rds"
                                  }
                              ],
                            "GroupDescription" : "Created from the RDS Management Console",
                            "VpcId" : { "Ref" : "VpcId" },
                            "SecurityGroupIngress" : [ {
                              "IpProtocol" : "tcp",
                              "FromPort" : "3306",
                              "ToPort" : "3306",
                              "CidrIp" : "0.0.0.0/0"}
                                ]
                            }
                      },
                      "DBTable": {
                          "Type": "AWS::DynamoDB::Table",
                          "Properties": {
                            "TableName": "csye6225",
                            "AttributeDefinitions" : [
                              {
                                "AttributeName" : "id",
                                "AttributeType" : "S"
                            }],
                            "KeySchema" : [
                              {
                                "AttributeName" : "id",
                                "KeyType" : "HASH"
                              }
                            ],
                            "ProvisionedThroughput" : {
                                "ReadCapacityUnits" : "5",
                                "WriteCapacityUnits" : "5"
                              },
                              "TimeToLiveSpecification":{
                                "AttributeName" : "ttl",
                                "Enabled" : "true"
                              }
                          }
                      },
                      "S3Bucket": {
                          "Type": "AWS::S3::Bucket",
                          "Properties": {"BucketName" : {"Ref": "DomainName"}}
                      },

                      "DBInstance" : {
                        "Type" : "AWS::RDS::DBInstance",
                        "Properties" : {
                          "DBName" : "csye6225",
                          "AllocatedStorage" : "20",
                          "DBInstanceClass" : "db.t2.medium",
                          "Engine" : "MySQL",
                          "DBInstanceIdentifier": "csye6225-spring2018",
                          "MasterUsername" : "csye6225master",
                          "MasterUserPassword" : "csye6225password",
                          "MultiAZ": "False",
                          "PubliclyAccessible":"False",
                          "VPCSecurityGroups":[{"Ref": "DBSecurityGroup"}],
                          "DBSubnetGroupName": {"Ref": "DBSubnetGroup"}
                        }
                      },

                      "DBSubnetGroup" : {
                       "Type" : "AWS::RDS::DBSubnetGroup",
                       "Properties" : {
                          "DBSubnetGroupDescription" : "DBSubnetGroup",
                          "SubnetIds" : [ {"Ref": "GroupSubnetId1"}, {"Ref": "GroupSubnetId2"} ],
                          "Tags" : [ {"Key" : "Name", "Value" : "Subnet for RDS instances"} ]
                       }
                    }
}

}
